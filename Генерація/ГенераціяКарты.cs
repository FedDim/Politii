using Политiи.Данныя;

namespace Политiи.Генерація
{
    public static class ГенераціяКарты
    {
        public static int[,] ГенераціяМѣстности()
        {
            int[,] картаМѣстности = new int[Дата.карта.Ширина, Дата.карта.Высота];
            float[,] картаВысотъ = new float[Дата.карта.Ширина, Дата.карта.Высота];

            Шумъ шумъ = new();

            for (int y = 0; y < Дата.карта.Высота; y++)
            {
                for (int x = 0; x < Дата.карта.Ширина; x++)
                {

                    картаВысотъ[x, y] = шумъ.МногократныйШумъ2Д(x / (float)Дата.карта.Ширина * 10, y / (float)Дата.карта.Высота * 10);
                }
            }

            Эрозія(картаВысотъ);


            for (int y = 0; y < Дата.карта.Высота; y++)
            {
                for (int x = 0; x < Дата.карта.Ширина; x++)
                {
                    float число = картаВысотъ[x, y];

                    if (число < 0.1f) картаМѣстности[x, y] = 0;
                    else if (число < 0.9f) картаМѣстности[x, y] = 1;
                    else картаМѣстности[x, y] = 2;
                }
            }



            return картаМѣстности;
        }

        public static void Эрозія(float[,] картаВысотъ, int капли = 50000, float скорость = 1.0f,
            float вмѣстимость = 5.0f, float коэффиціентъЭрозіи = 0.1f, float коэффиціентъОсажденія = 0.3f,
            int возможныеШаги = 100)
        {
            Random random = new();

            for (int i = 0; i < капли; i++)
            {
                int x = random.Next(Дата.карта.Ширина);
                int y = random.Next(Дата.карта.Высота);

                if (картаВысотъ[x, y] > 0.95f) continue;

                float вода = скорость;
                float матеріалъ = 0;

                for (int шагъ = 0; шагъ < возможныеШаги; шагъ++)
                {
                    int движеніеX = -1;
                    int движеніеY = -1;
                    float движеніеУклонъ = 0;

                    for (int dy = -1; dy <= 1; dy++)
                    {
                        for (int dx = -1; dx <= 1; dx++)
                        {
                            if (dx == 0 && dy == 0) continue;

                            int nx = x + dx;
                            int ny = y + dy;

                            if (nx >= 0 && nx < Дата.карта.Ширина && ny >= 0 && ny < Дата.карта.Высота)
                            {
                                float уклонъ = картаВысотъ[x, y] - картаВысотъ[nx, ny];

                                if (уклонъ > движеніеУклонъ)
                                {
                                    движеніеУклонъ = уклонъ;
                                    движеніеX = nx;
                                    движеніеY = ny;
                                }
                            }
                        }
                    }

                    if (движеніеX == -1 || движеніеY == -1 || движеніеУклонъ <= 0)
                    {
                        картаВысотъ[x, y] += матеріалъ * коэффиціентъОсажденія;
                        break;
                    }

                    x = движеніеX;
                    y = движеніеY;

                    float эрозія = Math.Min(движеніеУклонъ * коэффиціентъЭрозіи, вмѣстимость - матеріалъ);
                    картаВысотъ[x, y] -= эрозія;
                    матеріалъ += эрозія;

                    float осадокъ = матеріалъ * коэффиціентъОсажденія;
                    картаВысотъ[x, y] += осадокъ;
                    матеріалъ -= осадокъ;

                    вода *= 0.9f;
                    if (вода <= 0.01f) break;

                }
            }
        }
    }
}
